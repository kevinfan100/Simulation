% test_vd_manual.m
% æ‰‹å‹•æ¸¬è©¦ç”¨åƒæ•¸è¨­å®šè…³æœ¬
%
% ä½¿ç”¨æ–¹æ³•ï¼š
%   1. ä¿®æ”¹ä¸‹æ–¹çš„åƒæ•¸é…ç½®
%   2. åŸ·è¡Œæ­¤è…³æœ¬ï¼ˆå°‡åƒæ•¸è¼‰å…¥ workspaceï¼‰
%   3. æ‰‹å‹•åœ¨ Simulink ä¸­é–‹å•Ÿæ¨¡å‹ä¸¦æŒ‰æ’­æ”¾æŒ‰éˆ•
%   4. æŸ¥çœ‹æ¨¡æ“¬çµæœ

clear; clc;

fprintf('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
fprintf('           R Controller æ‰‹å‹•æ¸¬è©¦åƒæ•¸è¨­å®š\n');
fprintf('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n');

%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%                     åƒæ•¸é…ç½®å€ - åœ¨æ­¤ä¿®æ”¹åƒæ•¸
%  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

% â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
% â”‚ Vd Generator åƒæ•¸                                            â”‚
% â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
signal_type_name = 'sine';         % 'step' æˆ– 'sine'
Channel = 4;                       % æ¿€ç™¼é€šé“ (1-6)
Amplitude = 0.45;                  % æŒ¯å¹… [V]
Frequency = 100;                   % Sine é »ç‡ [Hz]
Phase = 0;                         % Sine ç›¸ä½ [deg]
StepTime = 0.1;                    % Step è·³è®Šæ™‚é–“ [s] (ç•¶ signal_type_name = 'step' æ™‚ä½¿ç”¨)

% å¸¸ç”¨æ¸¬è©¦ç¯„ä¾‹ (è¨»è§£æ‰æœªä½¿ç”¨çš„):
% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
% ç¯„ä¾‹ 1: ä½é »æ­£å¼¦æ³¢ (100 Hz)
%   Frequency = 100; Amplitude = 0.45; Channel = 4;
%
% ç¯„ä¾‹ 2: ä¸­é »æ­£å¼¦æ³¢ (1000 Hz)
%   Frequency = 1000; Amplitude = 1.0; Channel = 5;
%
% ç¯„ä¾‹ 3: é«˜é »æ­£å¼¦æ³¢ (5000 Hz)
%   Frequency = 5000; Amplitude = 0.5; Channel = 1;
%
% ç¯„ä¾‹ 4: Step éŸ¿æ‡‰æ¸¬è©¦
%   signal_type_name = 'step'; Amplitude = 1.0; StepTime = 0.1;
% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

% â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
% â”‚ Controller åƒæ•¸                                              â”‚
% â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
T = 1e-5;                          % æ¡æ¨£æ™‚é–“ [s] (100 kHz) - å›ºå®šå€¼ï¼Œä¸å»ºè­°ä¿®æ”¹
fB_c = 3200;                       % æ§åˆ¶å™¨é »å¯¬ [Hz]
fB_e = 16000;                      % ä¼°æ¸¬å™¨é »å¯¬ [Hz]
d = 2;                             % ç›¸å°éšæ•¸ (å›ºå®šç‚º 2)

% Controller é »å¯¬è¨­å®šç¯„ä¾‹:
% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
% é è¨­è¨­å®š (æ¨™æº–éŸ¿æ‡‰):
%   fB_c = 3200;   fB_e = 16000;   â†’ lambda_c â‰ˆ 0.8179, lambda_e â‰ˆ 0.3659
%
% ä¿å®ˆè¨­å®š (è¼ƒæ…¢ä½†ç©©å®š):
%   fB_c = 1600;   fB_e = 8000;    â†’ lambda_c â‰ˆ 0.9048, lambda_e â‰ˆ 0.6050
%
% æ¿€é€²è¨­å®š (å¿«é€ŸéŸ¿æ‡‰):
%   fB_c = 6400;   fB_e = 32000;   â†’ lambda_c â‰ˆ 0.6703, lambda_e â‰ˆ 0.1353
% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

% â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
% â”‚ Simulink åƒæ•¸                                                â”‚
% â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Ts = 1e-5;                         % æ¡æ¨£æ™‚é–“ [s] (100 kHz)

%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%                     è‡ªå‹•è¨ˆç®—çš„åƒæ•¸
%  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

% è½‰æ› SignalTypeï¼ˆå­—ä¸² â†’ æ•¸å­—ï¼Œçµ¦ Simulink ä½¿ç”¨ï¼‰
if strcmpi(signal_type_name, 'sine')
    SignalType = 1;
else
    SignalType = 2;
end

% è¨ˆç®— lambda åƒæ•¸
lambda_c = exp(-fB_c*T*2*pi);
lambda_e = exp(-fB_e*T*2*pi);
beta = sqrt(lambda_e * lambda_c);

%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%                     åƒæ•¸é©—è­‰èˆ‡é¡¯ç¤º
%  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

% é©—è­‰åƒæ•¸
if ~ismember(lower(signal_type_name), {'step', 'sine'})
    error('signal_type_name å¿…é ˆæ˜¯ ''step'' æˆ– ''sine''');
end

if Channel < 1 || Channel > 6
    error('Channel å¿…é ˆåœ¨ 1-6 ä¹‹é–“');
end

fprintf('ã€å·²è¼‰å…¥çš„ Workspace è®Šæ•¸ã€‘\n');
fprintf('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n');

fprintf('ğŸ“Œ Vd Generator åƒæ•¸:\n');
fprintf('   SignalType     = %d (%s)\n', SignalType, signal_type_name);
fprintf('   Channel        = %d (P%d)\n', Channel, Channel);
fprintf('   Amplitude      = %.3f V\n', Amplitude);
if strcmpi(signal_type_name, 'sine')
    fprintf('   Frequency      = %.1f Hz\n', Frequency);
    fprintf('   Phase          = %.1f deg\n', Phase);
else
    fprintf('   StepTime       = %.3f s\n', StepTime);
end
fprintf('\n');

fprintf('ğŸ“Œ Controller åƒæ•¸:\n');
fprintf('   T              = %.2e s (æ¡æ¨£é€±æœŸ)\n', T);
fprintf('   fB_c           = %d Hz (æ§åˆ¶å™¨é »å¯¬)\n', fB_c);
fprintf('   fB_e           = %d Hz (ä¼°æ¸¬å™¨é »å¯¬)\n', fB_e);
fprintf('   d              = %d (ç›¸å°éšæ•¸)\n', d);
fprintf('   lambda_c       = %.8f (è‡ªå‹•è¨ˆç®—)\n', lambda_c);
fprintf('   lambda_e       = %.8f (è‡ªå‹•è¨ˆç®—)\n', lambda_e);
fprintf('   beta           = %.8f (è‡ªå‹•è¨ˆç®—)\n', beta);
fprintf('\n');

fprintf('ğŸ“Œ Simulink åƒæ•¸:\n');
fprintf('   Ts             = %.2e s (100 kHz æ¡æ¨£)\n', Ts);
fprintf('\n');

fprintf('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
fprintf('âœ… åƒæ•¸å·²è¼‰å…¥å®Œæˆï¼\n');
fprintf('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n');

fprintf('ğŸ’¡ ä¸‹ä¸€æ­¥æ“ä½œ:\n');
fprintf('   1. åœ¨ Simulink ä¸­é–‹å•Ÿæ¨¡å‹: r_controller_system_integrated.slx\n');
fprintf('   2. é»æ“Šæ’­æ”¾æŒ‰éˆ•åŸ·è¡Œæ¨¡æ“¬\n');
fprintf('   3. æŸ¥çœ‹ Scope æˆ–è¼¸å‡ºè®Šæ•¸ (Vd, Vm, e, u, w1_hat)\n');
fprintf('\n');

fprintf('ğŸ“‹ Workspace ä¸­çš„é—œéµè®Šæ•¸:\n');
fprintf('   Vd Generator: SignalType, Channel, Amplitude, Frequency, Phase, StepTime\n');
fprintf('   Controller:   fB_c, fB_e, lambda_c, lambda_e, beta, d, T\n');
fprintf('   Simulink:     Ts\n');
fprintf('\n');

fprintf('âš ï¸  æ³¨æ„äº‹é …:\n');
fprintf('   - æ¨¡å‹æª”æ¡ˆä½ç½®: r_controller_package/model/r_controller_system_integrated.slx\n');
fprintf('   - è«‹ç¢ºä¿ Simulink çš„ Fixed-step size = %.2e (æˆ– auto)\n', Ts);
fprintf('   - å»ºè­°ä½¿ç”¨ ode45 æˆ– ode23tb solver\n');
fprintf('   - æ¨¡æ“¬æ™‚é–“å¯åœ¨ Simulink ä¸­è‡ªè¡Œè¨­å®š\n');
fprintf('\n');
